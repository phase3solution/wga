<?php /* Template Name: Risk Registry */get_header();global $user_switching;if (current_user_can('administrator') || current_user_can('advisor') || $user_switching->get_old_user()) {    $select_attr = '';    $save_btn = true;} else {	$select_attr = '';    $save_btn = true;	// $select_attr = 'disabled';    // $save_btn = false;} ?><div class="content-wrapper">	<div class="page-title">        <div>            <h1><img class="dashboardIcon" src="<?php echo get_template_directory_uri(); ?>/images/icon-rr.png" alt=""><?php _e('Risk Register', 'advisory'); ?></h1>        </div>        <div>            <ul class="breadcrumb">                <li><i class="fa fa-home fa-lg"></i></li>                <li><a href="#"><?php _e('Risk Register', 'advisory'); ?></a></li>            </ul>        </div>    </div>    <?php    $company_id = advisory_get_user_company_id();	if (advisory_metrics_in_progress($company_id, array('risk'))) {		$form_id = advisory_get_active_forms($company_id, array('risk'));	} else {		$id = new WP_Query([			'post_type' => 'risk',			'post_status' => 'archived',			'posts_per_page' => 1,			'meta_query' => [[				'key' => 'assigned_company',				'value' => $company_id,			]],			'fields' => 'ids',		]);		if ($id->found_posts > 0) {			$form_id = $id->posts;		}	}	if ($form_id[0]) {		$rr_data = advisory_get_formatted_rr_data($form_id[0]);	    foreach ($rr_data as $rr) {	    	if (@$_GET['cat'] != advisory_id_from_string($rr['cat'])) {	    		continue;	    	}	        $base = number_format($rr['base']) * 1000;	        foreach ($rr['areas'] as $area) {	        	$base++;		        $inherent = array();		        foreach ($area['impact'] as $key=> $val) {		            $inherent[] = $val * $area['probability'][$key];		        }		        $inherent = array_merge($inherent, $area['bool']);		        $inherent = (!empty($inherent) ? array_sum($inherent)/$area['nq']:0);		        $impact = (empty($area['impact']) ? 0 : round(array_sum($area['impact'])/count($area['impact'])));		        $probability = (empty($area['probability']) ? 0 : round(array_sum($area['probability'])/count($area['probability'])));		        $mitigation = (empty($area['mitigation']) ? 0 : round(array_sum($area['mitigation'])/count($area['mitigation'])));		        $rr_id = advisory_id_from_string($area['name']) . '_risk_registry';		        $default = advisory_company_default_values(advisory_get_user_company_id(), $rr_id);		        echo '<div class="row" id="risk_'. $form_id[0] .'">		            <div class="col-md-12">		                <form class="form rr-form" method="post" data-meta="' . $rr_id . '" data-id="'. advisory_get_user_company_id() .'">		                    <div class="card">		                        <div class="card-title-w-btn">		                            <h4 class="title">Category: ' . $rr['cat'] . '<br>		                            <small>' . $base . ' : ' . $area['name'] . '</small></h4>';		                            if ($save_btn) {		                            	echo '<button class="btn btn-success" type="submit"><i class="fa fa-lg fa-floppy-o"></i> Save</button>';		                            }	                            echo '</div>		                        <div class="card-body">		                            <div class="table-responsive table-risk-registry">		                                <table class="table table-bordered table-survey mb-none">		                                    <thead>		                                        <tr>		                                            <th style="width:35%;" class="t-heading-dark font-120p"><strong>Risk Description</big></th>		                                            <th style="width:15%;" class="t-heading-dark font-120p"><strong>Risk Owner</big></th>		                                            <th style="width:50%;" class="t-heading-dark font-120p"><strong>Comments (Last Assessment)</big></th>		                                        </tr>		                                    </thead>		                                    <tbody>		                                        <tr>		                                            <td class="no-padding">		                                                <textarea name="desc" class="form-control strong font-110p" ' . $select_attr . '>'.@$default['desc'].'</textarea>		                                            </td>		                                            <td class="no-padding">		                                                <textarea name="owner" class="form-control strong font-110p" ' . $select_attr . '>'.@$default['owner'].'</textarea>		                                            </td>		                                            <td class="no-padding">		                                                <textarea name="comments" class="form-control strong font-110p" ' . $select_attr . '>'.@$default['comments'].'</textarea>		                                            </td>		                                        </tr>		                                    </tbody>		                                </table>		                                <table class="table table-bordered table-survey">		                                    <tbody>		                                        <tr>		                                            <th colspan="3" class="t-heading-l-dark text-center font-120p">Inherent Risk</th>		                                            <th colspan="2" class="t-heading-l-dark text-center font-120p">Controls</th>		                                        </tr>		                                        <tr>		                                            <th class="t-heading-ll-dark text-center">Impact</th>		                                            <th class="t-heading-ll-dark text-center">Probability</th>		                                            <th class="t-heading-ll-dark text-center">Risk</th>		                                            <td rowspan="2" colspan="2" class="no-padding width-65p">		                                                <textarea name="controls" class="form-control strong font-110p" ' . $select_attr . '>'.@$default['controls'].'</textarea>		                                            </td>		                                        </tr>		                                        <tr>		                                            <td class="text-center font-14px ' . coloring_elements($impact, 'select', true) . '">		                                                ' . $impact . '		                                            </td>		                                            <td class="text-center font-14px ' . coloring_elements($probability, 'select', true) . '">		                                                ' . $probability . '		                                            </td>		                                            <td class="text-center font-14px ' . coloring_elements(($inherent == 0 ? round($area['avg']) : round($inherent)), 'risk-score') . '">		                                                ' . ($inherent == 0 ? round($area['avg']) : round($inherent)) . '		                                            </td>		                                        </tr>		                                        <tr>		                                            <th colspan="3" class="t-heading-l-dark text-center font-120p">Residual Risk</th>		                                            <th class="t-heading-l-dark text-center font-120p">Additional Mitigation Options</th>		                                            <th class="t-heading-l-dark text-center font-120p">Target</th>		                                        </tr>		                                        <tr>		                                            <th class="t-heading-ll-dark text-center">Inherent</th>		                                            <th class="t-heading-ll-dark text-center">Mitigation</th>		                                            <th class="t-heading-ll-dark text-center">Residual Risk</th>		                                            <td rowspan="2" class="no-padding">		                                                <textarea name="additional_mitigation" class="form-control strong font-110p" ' . $select_attr . '>'.@$default['additional_mitigation'].'</textarea>		                                            </td>		                                            <td rowspan="2" class="no-padding">		                                                '.  advisory_opt_select('target', '', 'invisible-opt', '', [1 => 'Green', 2 => 'Yellow', 3 => 'Orange', 4 => 'Red'], @$default['target']) .'		                                            </td>		                                        </tr>		                                        <tr>		                                            <td class="text-center font-14px ' . coloring_elements(($inherent == 0 ? round($area['avg']) : round($inherent)), 'risk-score') . '" id="inherent-val">		                                                ' . ($inherent == 0 ? round($area['avg']) : round($inherent)) . '		                                            </td>		                                            <td class="text-center font-14px" id="color-hudai">		                                                ' . advisory_opt_select('mitigation', 'mitigation', 'mitigation', $select_attr, [0 => 'None', 20 => 'Low', 50 => 'Medium', 80 => 'High', 100 => 'Very High'], @$default['mitigation']) . '		                                            </td>		                                            <td class="text-center font-14px" id="residual-risk">		                                            </td>		                                        </tr>		                                    </tbody>		                                </table>		                            </div>		                        </div>		                    </div>		                </form>		            </div>		        </div>';	        }	    }	} else {		echo '<p>' . __('Risk Register Not Available Yet') . '</p>';	} ?></div><?php get_footer(); ?>