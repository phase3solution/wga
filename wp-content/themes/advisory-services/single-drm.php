<?phpget_header();$opts = get_post_meta(get_the_ID(), 'form_opts', true);$area_meta = advisory_area_exists(get_the_ID(), advisory_id_from_string($_GET['area']));$area_id = 'sections_' . advisory_id_from_string($_GET['area']);$transient_post_id = get_the_ID();if (isset($_GET['edit']) && $_GET['edit'] == 'true') {    $select_attr = '';    $publish_btn = false;} else if (get_the_author_meta( 'spuser', get_current_user_id()) && empty($user_switching->get_old_user())) {    $select_attr = '';    $publish_btn = false;    $_GET['edit'] = true;    $_GET['view'] = false;    $prefix = 'view=true&';} else if (isset($_GET['view']) && $_GET['view'] == 'true') {    $select_attr = 'disabled';    $publish_btn = true;} else {    $select_attr = '';    $publish_btn = true;} ?>    <div class="content-wrapper">        <!-- Page Title -->        <div class="page-title">            <div>                <h1><?php echo (!empty($area_meta['icon_title']) ? '<img src="' . $area_meta['icon_title'] . '"> ' : '') ?><?php echo $area_meta['name'] ?></h1>            </div>            <?php if ($select_attr == '') { ?>                <div>                    <?php if($publish_btn == true) {                        if (advisory_is_valid_form_submission(get_the_ID())) {                            echo '<a class="btn btn-lg btn-info btn-publish" href="#" data-id="' . $transient_post_id . '">Publish</a>';                        } else {                            echo '<a class="btn btn-lg btn-default btn-publish" href="#" data-id="' . $transient_post_id . '">Publish</a>';                        }                    } ?>                    <a class="btn btn-lg btn-success btn-save-all" href="#">Save All</a>                    <a class="btn btn-lg btn-warning btn-reset-all" href="#">Reset</a>                </div>            <?php } ?>            <div>                <ul class="breadcrumb">                    <li><i class="fa fa-home fa-lg"></i></li>                    <li><a href="#"><?php echo advisory_get_form_name(get_the_ID()) ?></a></li>                    <li><a href="#"><?php echo $area_meta['name'] ?></a></li>                </ul>            </div>        </div>        <div class="panel">            <div class="panel-body">                <div class="panel-chart">                    <div class="row">                        <div class="col-sm-5">                            <img src="<?php echo get_template_directory_uri(); ?>/images/dr-readiness.jpg" class="img-responsive text-center" usemap="#Map" hidefocus="true" />                            <map name="Map" id="Map">                                <area target="" alt="" title="" href="<?php echo advisory_graphic_link(array('drm'), 'organizational_readiness') ?>" coords="4,3,511,2,513,250,516,257,523,255,541,241,558,237,575,248,581,265,582,280,576,295,566,306,553,312,534,306,521,292,512,296,512,352,512,419,512,505,298,510,285,509,277,502,287,490,297,472,293,454,274,441,259,438,245,440,229,450,221,471,225,485,236,494,238,506,225,507,6,507" shape="poly">                                <area target="" alt="" title="" href="<?php echo advisory_graphic_link(array('drm'), 'technology_readiness') ?>" coords="514,4,1021,1,1020,507,786,508,784,515,793,523,801,533,802,551,795,565,782,574,764,578,750,574,741,570,732,557,730,542,736,529,744,520,750,513,744,507,513,509,514,295,523,293,530,300,537,306,548,310,559,311,568,308,575,298,581,290,584,276,582,263,575,248,565,239,554,236,545,237,536,241,529,247,524,253,518,256,512,246" shape="poly">                                <area target="" alt="" title="" href="<?php echo advisory_graphic_link(array('drm'), 'maintenance_sand_improvement') ?>" coords="1020,1014,1020,509,785,510,787,519,797,526,802,536,804,547,801,560,794,573,770,579,746,573,733,561,729,548,729,539,731,532,734,526,740,520,746,515,745,510,514,510,512,743,506,745,497,738,488,731,478,726,466,729,456,734,448,746,445,759,447,772,452,786,461,793,472,797,482,794,488,790,495,783,502,778,508,775,514,780,512,790,514,1013" shape="poly">                                <area target="" alt="" title="" href="<?php echo advisory_graphic_link(array('drm'), 'recovery_planning') ?>" coords="4,1014,511,1013,511,781,503,780,499,788,491,794,484,798,475,798,465,796,452,786,444,768,444,754,447,741,453,732,464,725,481,723,491,727,500,735,510,742,509,509,471,511,276,510,276,499,292,484,295,466,288,452,278,443,257,440,238,445,226,458,222,473,227,485,235,493,242,501,241,508,231,509,6,511" shape="poly">                            </map>                               </div>                        <div class="col-sm-7">                            <h3 class="cr-section-title" style="background:<?php echo $area_meta['color'] ?>"><img src="<?php echo $area_meta['icon_menu'] ?>"> <?php echo $area_meta['name'] ?></h3>                            <p><?php echo $area_meta['desc']; ?></p>                        </div>                    </div>                </div>            </div>        </div>        <?php if (!empty($opts[$area_id])) {            foreach ($opts[$area_id] as $section) {                $section_id = $area_id . '_tables_' . advisory_id_from_string($section['name']);                $default = advisory_form_default_values($transient_post_id, $section_id);                $fields = $section['fields'];                echo '<div class="row survey-drm">                    <div class="col-md-12">                        <form class="survey-form single" method="post" data-meta="'. $section_id .'" data-id="'. $transient_post_id .'">                            <div class="card">                                <div class="card-title-w-btn">                                    <h4 class="title">' . $section['name'] . '</h4>                                    <div class="btn-group">';                                        if ($opts['criteria_definition']) {                                            echo '<a class="btn btn-info" data-toggle="modal" data-target="#helpModal">Criteria Rating Definitions</a>';                                        }                                        if ($section['docs']) {                                            echo '<a class="btn btn-warning" target="_blank" href="' . $section['docs'] . '">Documentation</a>';                                        }                                        if ($select_attr == '') {                                            echo '<button class="btn btn-success" type="submit"><i class="fa fa-lg fa-floppy-o"></i> Save</button>';                                        }                                    echo '</div>                                </div>                                <div class="card-body">';                                    if($section['desc']) {                                        echo '<p>' . $section['desc'] . '</p>';                                    }                                    $tables = isset($opts[$section_id]) ? $opts[$section_id] : array();                                    if (!empty($tables)) {                                        foreach ($tables as $table) {                                            $table_id = $section_id . '_questions_' . advisory_id_from_string($table['name']);                                            $count = 0;                                            echo '<div class="table-responsive">';                                            echo '<table class="table table-bordered table-survey table-single-criteria">                                                <thead>                                                    <tr>                                                        <th class="t-heading-dark text-center"><big><strong>Topic Area</strong></big></th>';                                                        $total = 0;                                                        $max = 0;                                                        $questions = $opts[$table_id];                                                        $max += count($questions) * 5;                                                        foreach ($questions as $question) {                                                            $question_id = $table_id . '_question_' . advisory_id_from_string($question['title']);                                                            foreach ($fields as $f_key => $field) {                                                                $field_id = $question_id . '_' . $field;                                                                $total += (isset($default[$field_id]) ? $default[$field_id] : 0);                                                                break;                                                            }                                                        }                                                        echo '<th class="t-heading-dark text-center"><strong>Rating</strong><br>(<span class="total">'. $total .'</span> out of ' . $max . ' / Avg: <span class="avg">'. @$default['avg'] .'</span>)</th>                                                        <th class="t-heading-dark text-center"><big><strong>Comments</strong></big></th>';                                                    echo '</tr>                                                </thead>                                                <tbody>';                                                    foreach ($questions as $question) {                                                        $question_id = $table_id . '_question_' . advisory_id_from_string($question['title']);                                                        $title = trim($question['title']);                                                        $desc = trim($question['desc']);                                                        $count++;                                                        echo '<tr>                                                            <td width="60%">' . $count . '. ';                                                                if (empty($desc)) {                                                                    echo $title;                                                                } else {                                                                    echo '<strong>' . $title . '</strong> <i>('. $desc .')</i>';                                                                }                                                            echo '</td>';                                                            foreach ($fields as $f_key => $field) {                                                                $field_id = $question_id . '_' . $field;                                                                $field_id = str_replace('.', '_', $field_id);                                                                echo '<td width="15%">' . advisory_opt_select($field_id, '', '', $select_attr, $field, @$default[$field_id]) .'<input type="hidden" class="rating" value="' . (isset($default[$field_id]) ? $default[$field_id] : 0) . '"></td>';                                                            }                                                            echo '<td class="no-padding"><textarea name="'. $table_id . '_' . $question_id .'_comment" class="form-control"'.$select_attr.'>'. @$default["{$table_id}_{$question_id}_comment"] .'</textarea></td>';                                                        echo '</tr>';                                                    }                                                echo '</tbody>                                            </table>';                                            echo '</div>';                                        }                                    }                                echo '</div>                                <div class="card-footer text-right">                                    <input type="hidden" name="avg" class="hidden-avg" value="' .  @$default['avg'] . '">';                                    if ($select_attr == '') {                                        echo '<button class="btn btn-success btn-submit-primary" type="submit"><i class="fa fa-lg fa-floppy-o"></i> Save</button>';                                    }                                echo '</div>                            </div>                        </form>                    </div>                </div>';            }        }    echo '</div>';    // Modal    if ($opts['criteria_definition']) {        echo '<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModal">            <div class="modal-dialog modal-lg" role="document">                <div class="modal-content">                    <div class="modal-header">                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                        <h4 class="modal-title" id="helpModal">Criteria Rating Definitions</h4>                    </div>                    <div class="modal-body">                        <div class="criteria-rating">                            <div class="criteria-heading">                                <h4>Criteria Rating Definitions</h4>                            </div>                            ' . cs_get_option('criteria_rating_definitions') . '                        </div>                    </div>                    <div class="modal-footer">                        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>                    </div>                </div>            </div>        </div>';    }get_footer(); ?>