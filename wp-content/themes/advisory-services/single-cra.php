<?php get_header();$opts = get_post_meta(get_the_ID(), 'form_opts', true);$area_meta = advisory_area_exists(get_the_ID(), advisory_id_from_string($_GET['area']));$area_id = 'sections_' . advisory_id_from_string($_GET['area']);$transient_post_id = get_the_ID();if (isset($_GET['view']) && $_GET['view'] == 'true') {    $select_attr = 'disabled';    $publish_btn = true;} elseif (isset($_GET['edit']) && $_GET['edit'] == 'true') {    $select_attr = '';    $publish_btn = false;} else {    $select_attr = '';    $publish_btn = true;} ?><script src="<?php echo P3_TEMPLATE_URI. '/js/plugins/jquery.tinymce.min.js'; ?>"></script><div class="content-wrapper">    <!-- Page Title -->    <div class="page-title">        <div>            <h1><?php echo (!empty($area_meta['icon_title']) ? '<img src="' . $area_meta['icon_title'] . '"> ' : '') ?><?php echo $area_meta['name'] ?></h1>        </div>        <?php if ($select_attr == '') { ?>            <div>                <?php if($publish_btn == true) {                    if (advisory_is_valid_form_submission(get_the_ID())) {                        echo '<a class="btn btn-lg btn-info btn-publish" href="#" data-id="' . $transient_post_id . '">Publish</a>';                    } else {                        echo '<a class="btn btn-lg btn-default btn-publish" href="#" data-id="' . $transient_post_id . '">Publish</a>';                    }                } ?>                <a class="btn btn-lg btn-success btn-save-all" href="#">Save All</a>                <a class="btn btn-lg btn-warning btn-reset-all" href="#">Reset</a>            </div>        <?php } ?>        <div>            <ul class="breadcrumb">                <li><i class="fa fa-home fa-lg"></i></li>                <li><a href="#"><?php echo advisory_get_form_name(get_the_ID()) ?></a></li>                <li><a href="#"><?php echo $area_meta['name'] ?></a></li>            </ul>        </div>    </div>    <div class="panel">        <div class="panel-body">            <div class="panel-chart">                <div class="row">                    <div class="col-sm-5">                        <?php if (!empty($opts['area_image'])) {                            $map_1 = !empty($opts['areas'][1]['name']) ? $opts['areas'][1]['name'] : '';                            $map_2 = !empty($opts['areas'][2]['name']) ? $opts['areas'][2]['name'] : '';                            $map_3 = !empty($opts['areas'][3]['name']) ? $opts['areas'][3]['name'] : '';                            $map_4 = !empty($opts['areas'][4]['name']) ? $opts['areas'][4]['name'] : '';                            echo '<img src="'.$opts['area_image'].'" class="img-responsive text-center" usemap="#Map" hidefocus="true" />';                            echo '<map name="Map" id="Map">';                                echo '<area alt="'.$map_1.'" title="'.$map_1.'" href="'.advisory_graphic_link(array('cra'), advisory_id_from_string($map_1)).'" coords="1,0,352,345" shape="rect">';                                echo '<area alt="'.$map_2.'" title="'.$map_2.'" href="'.advisory_graphic_link(array('cra'), advisory_id_from_string($map_2)).'" coords="351,3,698,347" shape="rect">';                                echo '<area alt="'.$map_4.'" title="'.$map_4.'" href="'.advisory_graphic_link(array('cra'), advisory_id_from_string($map_4)).'" coords="350,349,699,692" shape="rect">';                                echo '<area alt="'.$map_3.'" title="'.$map_3.'" href="'.advisory_graphic_link(array('cra'), advisory_id_from_string($map_3)).'" coords="0,348,348,694" shape="rect">';                            echo '</map>';                        } ?>                          </div>                    <div class="col-sm-7">                        <h3 class="cr-section-title" style="background:<?php echo $area_meta['color'] ?>"><img src="<?php echo $area_meta['icon_menu'] ?>"> <?php echo $area_meta['name'] ?></h3>                        <p><img src="<?php echo $area_meta['desc']; ?>" alt="name" class="img-responsive"></p>                    </div>                </div>            </div>        </div>    </div>    <?php if (!empty($opts[$area_id])) {        foreach ($opts[$area_id] as $section) {            $section_id = $area_id . '_tables_' . advisory_id_from_string($section['name']);            $default = advisory_form_default_values($transient_post_id, $section_id);            $fields = $section['fields'];            echo '<div class="row">                <div class="col-md-12">                    <form class="survey-form single" method="post" data-meta="'. $section_id .'" data-id="'. $transient_post_id .'">                        <div class="card">                            <div class="card-title-w-btn">                                <h4 class="title">' . $section['name'] . '</h4>                                <div class="btn-group">';                                    if ($opts['criteria_definition']) echo '<a class="btn btn-info" data-toggle="modal" data-target="#helpModal">Criteria Rating Definitions</a>';                                    if ($section['docs']) echo '<a class="btn btn-warning" target="_blank" href="' . $section['docs'] . '">Documentation</a>';                                    if ($select_attr == '') echo '<button class="btn btn-success" type="submit"><i class="fa fa-lg fa-floppy-o"></i> Save</button>';                                echo '</div>                            </div>                            <div class="card-body">';                                if($section['desc']) echo '<p>' . $section['desc'] . '</p>';                                $tables = isset($opts[$section_id]) ? $opts[$section_id] : array();                                if (!empty($tables)) {                                    foreach ($tables as $table) {                                        $table_id = $section_id . '_questions_' . advisory_id_from_string($table['name']);                                        $count = 0;                                        echo '<div class="table-responsive">';                                        echo '<table class="table table-bordered table-survey table-single-criteria-cra">                                            <thead>                                                <tr>                                                    <th class="t-heading-dark text-center"><big><strong>Topic Area</strong></big></th>';                                                    $total = 0;                                                    $max = 0;                                                    $questions = $opts[$table_id];                                                    $max += count($questions) * 5;                                                    foreach ($questions as $question) {                                                        $question_id = $table_id . '_question_' . advisory_id_from_string($question['title']);                                                        foreach ($fields as $f_key => $field) {                                                            $field_id = $question_id . '_' . $field;                                                            $total += (isset($default[$field_id]) ? $default[$field_id] : 0);                                                            break;                                                        }                                                    }                                                    echo '<th class="t-heading-dark text-center no-padding" width="180"><strong>Rating</strong><br>(<span class="total">'. $total .'</span> out of ' . $max . ' / Avg: <span class="avg">'. @$default['avg'] .'</span>)</th>                                                    <th class="t-heading-dark text-center" width="115"><big><strong>Comments</strong></big></th>';                                                echo '</tr>                                            </thead>                                            <tbody>';                                                foreach ($questions as $question) {                                                    $question_id = $table_id . '_question_' . advisory_id_from_string($question['title']);                                                    $title = trim($question['title']);                                                    $desc = trim($question['desc']);                                                    if (!empty($desc)) $title .= '<strong> <i>('. $desc .')</i></strong>';                                                    $comment_id = $table_id . '_' . $question_id .'_comment';                                                     $comment = !empty($default[$comment_id]) ? ['text'=>$default[$comment_id], 'cls' => 'bg-red'] : ['text' => '', 'cls' => 'bg-green'];                                                    $count++;                                                    echo '<tr>                                                        <td>'. $count . '. '.$title.'</td>';                                                        foreach ($fields as $f_key => $field) {                                                            $field_id = $question_id . '_' . $field;                                                            echo '<td>' . advisory_opt_select($field_id, '', '', $select_attr, $field, @$default[$field_id]) .'<input type="hidden" class="rating" value="' . (isset($default[$field_id]) ? $default[$field_id] : 0) . '"></td>';                                                        }                                                        echo '<td class="bigComment pointer '.$comment['cls'].'" isactive="'.$select_attr.'"><textarea name="'. $comment_id .'" class="hidden bigComment_text">'.htmlentities($comment['text']).'</textarea></td>';                                                        // echo '<td class="no-padding"><textarea name="'. $table_id . '_' . $question_id .'_comment" class="form-control">'. @$default["{$table_id}_{$question_id}_comment"] .'</textarea></td>';                                                    echo '</tr>';                                                }                                            echo '</tbody>                                        </table>';                                        echo '</div>';                                    }                                }                            echo '</div>                            <div class="card-footer text-right">                                <input type="hidden" name="avg" class="hidden-avg" value="' .  @$default['avg'] . '">';                                if ($select_attr == '') {                                    echo '<button class="btn btn-success btn-submit-primary" type="submit"><i class="fa fa-lg fa-floppy-o"></i> Save</button>';                                }                            echo '</div>                        </div>                    </form>                </div>            </div>';        }    }echo '</div>';// Modalif ($opts['criteria_definition']) {    echo '<div class="modal fade" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModal">        <div class="modal-dialog modal-lg" role="document">            <div class="modal-content">                <div class="modal-header">                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>                    <h4 class="modal-title" id="helpModal">Criteria Rating Definitions</h4>                </div>                <div class="modal-body">                    <div class="criteria-rating">                        <div class="criteria-heading">                            <h4>Criteria Rating Definitions</h4>                        </div>                        ' . cs_get_option('criteria_rating_definitions') . '                    </div>                </div>                <div class="modal-footer">                    <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>                </div>            </div>        </div>    </div>';}echo '<div class="modal fade" id="bigCommentModal">    <div class="modal-dialog modal-lg">        <div class="modal-content modal-inverse">            <div class="modal-header">                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>                <h4 class="modal-title">Comment</h4>            </div>            <div class="modal-body no-padding"></div>            <div class="modal-footer">                <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>                <button type="button" class="btn btn-primary saveBtn">Save changes</button>            </div>        </div>    </div></div>';get_footer(); ?><script>(function($) {    'use strict';    $(document).on('click', '.bigComment', function(event) {        event.preventDefault();        $(this).addClass('activeComment');        var comment = $('.bigComment.activeComment .bigComment_text');        var modal = $('#bigCommentModal');        var commentHTML = comment.val();        var excerpt_length = comment.attr('excerpt_length');        var title = comment.attr('title');        var textareaSelector = modal.find('.modal-body');        var textarea = $(textareaSelector);        var is_active = $('.bigComment.activeComment').attr('isactive');        $('#bigCommentModal').find('.modal-title').html(title);        if (is_active.length > 0) {            modal.find('.saveBtn').addClass('hide');            textarea.html('<div style="font-size:18px; font-family: Roboto, sans-serif;padding: 15px;">'+ commentHTML +'</div>');        } else {            modal.find('.saveBtn').removeClass('hide');            textarea.html('<textarea rows="18" class="no-border" excerpt_length='+excerpt_length+'>'+ commentHTML +'</textarea>');            tinymce();        }        modal.modal('show');    });    $('#bigCommentModal .saveBtn').on('click', function() {        var modal = $('#bigCommentModal');        var modal_comment = $('#bigCommentModal textarea');        var main_comment_area = $('.bigComment.activeComment');        var commentHTML = tinyMCE.activeEditor.getContent();        var commentText = commentHTML.replace(/(<([^>]+)>)/ig,"");        modal_comment.html('');        main_comment_area.removeClass('bg-red bg-green');        // main_comment_area.find('span').html(excerpt);        if (commentText.length > 0) main_comment_area.addClass('bg-red');        else main_comment_area.addClass('bg-green');        main_comment_area.find('.bigComment_text').val(commentHTML);        modal.modal('hide');    });    $('#bigCommentModal').on('hide.bs.modal', function() {        $('.bigComment').removeClass('activeComment');        $(this).find('textarea').val('');    });    function tinymce() {        tinyMCE.init({            selector: '#bigCommentModal textarea',            height: 450,            plugins: 'lists link autolink',            toolbar: '"styleselect | bold italic underline | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link',            menubar: false,            branding: false,            toolbar_drawer: 'floating',            tinycomments_mode: 'embedded',            tinycomments_author: 'Author name',            content_style: ".mce-content-body {font-size:18px; font-family: 'Roboto', sans-serif;}",            // height:"350px",            // width:"600px"        });    }}(jQuery))</script>